# ДЗ №2 по теме "Репликация и шардирование"

Проделанные действия:
- Развернуто 3 ноды кликхауса с репликацией
- Создана БД сразу на всех нодах
```sql
clickhouse01 :) CREATE DATABASE company_db ON CLUSTER 'cluster';
```
- Создана таблица сразу на всех нодах
```sql
clickhouse01 :) CREATE TABLE company_db.events ON CLUSTER 'cluster' (
    time DateTime,
    uid  Int64,
    type LowCardinality(String)
)
ENGINE = ReplicatedMergeTree('/clickhouse/shard_{shard}/{database}/{table}', '{replica}')
PARTITION BY toDate(time)
ORDER BY (uid);
```
- И добавлены данные
```sql
clickhouse01 :) INSERT INTO company_db.events VALUES
    ('2021-01-01 10:00:00', 100, 'view'),
    ('2021-01-01 10:05:00', 101, 'view'),
    ('2021-01-01 11:00:00', 100, 'contact'),
    ('2021-01-01 12:10:00', 101, 'view'),
    ('2021-01-02 08:10:00', 100, 'view'),
    ('2021-01-03 13:00:00', 103, 'view');
```
- Проверяем на других нодах наличие данных в этой таблице
```sql
clickhouse03 :) SELECT * FROM company_db.events;

┌────────────────time─┬─uid─┬─type─┐
│ 2021-01-02 08:10:00 │ 100 │ view │
└─────────────────────┴─────┴──────┘
┌────────────────time─┬─uid─┬─type────┐
│ 2021-01-01 10:00:00 │ 100 │ view    │
│ 2021-01-01 11:00:00 │ 100 │ contact │
│ 2021-01-01 10:05:00 │ 101 │ view    │
│ 2021-01-01 12:10:00 │ 101 │ view    │
└─────────────────────┴─────┴─────────┘
┌────────────────time─┬─uid─┬─type─┐
│ 2021-01-03 13:00:00 │ 103 │ view │
└─────────────────────┴─────┴──────┘
```
- Далее роняется главная нода `docker container stop clickhouse01`
- Проверяется что вставка с другой ноы по прежнему работает
```sql
clickhouse02 :) INSERT INTO company_db.events VALUES
    ('2022-01-01 10:00:00', 100, 'view'),
    ('2022-01-01 10:05:00', 101, 'view'),
    ('2022-01-01 11:00:00', 100, 'contact'),
    ('2022-01-01 12:10:00', 101, 'view'),
    ('2022-01-02 08:10:00', 100, 'view'),
    ('2022-01-03 13:00:00', 103, 'view');
```
- И чтение с третьей ноды тоже:
```sql
clickhouse03 :) SELECT * FROM company_db.events;

┌────────────────time─┬─uid─┬─type─┐
│ 2022-01-03 13:00:00 │ 103 │ view │
└─────────────────────┴─────┴──────┘
┌────────────────time─┬─uid─┬─type────┐
│ 2022-01-01 10:00:00 │ 100 │ view    │
│ 2022-01-01 11:00:00 │ 100 │ contact │
│ 2022-01-01 10:05:00 │ 101 │ view    │
│ 2022-01-01 12:10:00 │ 101 │ view    │
└─────────────────────┴─────┴─────────┘
┌────────────────time─┬─uid─┬─type────┐
│ 2021-01-01 10:00:00 │ 100 │ view    │
│ 2021-01-01 11:00:00 │ 100 │ contact │
│ 2021-01-01 10:05:00 │ 101 │ view    │
│ 2021-01-01 12:10:00 │ 101 │ view    │
└─────────────────────┴─────┴─────────┘
┌────────────────time─┬─uid─┬─type─┐
│ 2022-01-02 08:10:00 │ 100 │ view │
└─────────────────────┴─────┴──────┘
┌────────────────time─┬─uid─┬─type─┐
│ 2021-01-03 13:00:00 │ 103 │ view │
└─────────────────────┴─────┴──────┘
┌────────────────time─┬─uid─┬─type─┐
│ 2021-01-02 08:10:00 │ 100 │ view │
└─────────────────────┴─────┴──────┘
```
